{% extends "admin/base.html" %}

{% block admin_content %}
<div class="admin-settings">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 style="margin: 0; color: #303133;">系统设置</h2>
        <div>
            <el-button type="primary" @click="saveSettings">
                <i class="el-icon-check"></i> 保存设置
            </el-button>
        </div>
    </div>

    <form method="POST" id="settingsForm">
        <div style="display: grid; grid-template-columns: 1fr 300px; gap: 20px;">
            <!-- 主要内容区 -->
            <div>
                <!-- 基本设置 -->
                <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px;">
                    <h3 style="margin: 0 0 20px 0; color: #303133; font-size: 16px;">基本设置</h3>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 8px; color: #606266; font-size: 14px; font-weight: 500;">网站标题 <span style="color: #f56c6c;">*</span></label>
                        <el-input name="site_title" value="{{ settings.site_title if settings.site_title else '' }}" placeholder="请输入网站标题" required></el-input>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 8px; color: #606266; font-size: 14px; font-weight: 500;">网站描述</label>
                        <el-input name="site_description" type="textarea" :rows="3" placeholder="请输入网站描述">{{ settings.site_description if settings.site_description else '' }}</el-input>
                        <div style="font-size: 12px; color: #909399; margin-top: 4px;">用于SEO，建议150字符以内</div>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 8px; color: #606266; font-size: 14px; font-weight: 500;">网站关键词</label>
                        <el-input name="site_keywords" placeholder="多个关键词用逗号分隔">{{ settings.site_keywords if settings.site_keywords else '' }}</el-input>
                        <div style="font-size: 12px; color: #909399; margin-top: 4px;">用于SEO，多个关键词用英文逗号分隔</div>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 8px; color: #606266; font-size: 14px; font-weight: 500;">网站地址</label>
                        <el-input name="site_url" placeholder="https://example.com">{{ settings.site_url if settings.site_url else '' }}</el-input>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 8px; color: #606266; font-size: 14px; font-weight: 500;">管理员邮箱</label>
                        <el-input name="admin_email" type="email" placeholder="admin@example.com">{{ settings.admin_email if settings.admin_email else '' }}</el-input>
                    </div>
                </div>

                <!-- 显示设置 -->
                <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px;">
                    <h3 style="margin: 0 0 20px 0; color: #303133; font-size: 16px;">显示设置</h3>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 8px; color: #606266; font-size: 14px; font-weight: 500;">每页文章数</label>
                        <el-input-number name="posts_per_page" :min="5" :max="50" value="{{ settings.posts_per_page if settings.posts_per_page else 10 }}" style="width: 200px;"></el-input-number>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 8px; color: #606266; font-size: 14px; font-weight: 500;">时区</label>
                        <el-select name="timezone" placeholder="选择时区" style="width: 200px;" value="{{ settings.timezone if settings.timezone else 'Asia/Shanghai' }}">
                            <el-option label="北京时间 (UTC+8)" value="Asia/Shanghai"></el-option>
                            <el-option label="东京时间 (UTC+9)" value="Asia/Tokyo"></el-option>
                            <el-option label="纽约时间 (UTC-5)" value="America/New_York"></el-option>
                            <el-option label="伦敦时间 (UTC+0)" value="Europe/London"></el-option>
                        </el-select>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 8px; color: #606266; font-size: 14px; font-weight: 500;">日期格式</label>
                        <el-select name="date_format" placeholder="选择日期格式" style="width: 200px;" value="{{ settings.date_format if settings.date_format else '%Y-%m-%d' }}">
                            <el-option label="2024-01-01" value="%Y-%m-%d"></el-option>
                            <el-option label="2024/01/01" value="%Y/%m/%d"></el-option>
                            <el-option label="01/01/2024" value="%m/%d/%Y"></el-option>
                            <el-option label="2024年1月1日" value="%Y年%m月%d日"></el-option>
                        </el-select>
                    </div>
                </div>

                <!-- 评论设置 -->
                <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <h3 style="margin: 0 0 20px 0; color: #303133; font-size: 16px;">评论设置</h3>
                    
                    <div style="margin-bottom: 15px;">
                        <el-checkbox name="comment_moderation" {% if settings.comment_moderation == 'true' %}checked{% endif %}>
                            评论需要审核
                        </el-checkbox>
                        <div style="font-size: 12px; color: #909399; margin-top: 4px;">新评论需要管理员审核后才能显示</div>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <el-checkbox name="comment_registration" {% if settings.comment_registration == 'true' %}checked{% endif %}>
                            仅注册用户可评论
                        </el-checkbox>
                        <div style="font-size: 12px; color: #909399; margin-top: 4px;">只有注册用户才能发表评论</div>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 8px; color: #606266; font-size: 14px; font-weight: 500;">评论审核关键词</label>
                        <el-input name="comment_blacklist" type="textarea" :rows="3" placeholder="每行一个关键词">{{ settings.comment_blacklist if settings.comment_blacklist else '' }}</el-input>
                        <div style="font-size: 12px; color: #909399; margin-top: 4px;">包含这些关键词的评论将自动标记为垃圾评论</div>
                    </div>
                </div>
            </div>

            <!-- 侧边栏 -->
            <div>
                <!-- 快速操作 -->
                <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px;">
                    <h3 style="margin: 0 0 20px 0; color: #303133; font-size: 16px;">快速操作</h3>
                    
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <el-button type="primary" native-type="submit" style="width: 100%;">
                            <i class="el-icon-check"></i> 保存设置
                        </el-button>
                        <el-button @click="resetSettings" style="width: 100%;">
                            <i class="el-icon-refresh"></i> 重置设置
                        </el-button>
                        <el-button @click="exportSettings" style="width: 100%;">
                            <i class="el-icon-download"></i> 导出设置
                        </el-button>
                        <el-button @click="importSettings" style="width: 100%;">
                            <i class="el-icon-upload2"></i> 导入设置
                        </el-button>
                    </div>
                </div>

                <!-- 系统信息 -->
                <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <h3 style="margin: 0 0 20px 0; color: #303133; font-size: 16px;">系统信息</h3>
                    
                    <div style="font-size: 12px; color: #909399; line-height: 1.6;">
                        <div style="margin-bottom: 8px;">
                            <strong>Noteblog版本：</strong>1.0.0
                        </div>
                        <div style="margin-bottom: 8px;">
                            <strong>Python版本：</strong>3.8+
                        </div>
                        <div style="margin-bottom: 8px;">
                            <strong>Flask版本：</strong>2.0+
                        </div>
                        <div style="margin-bottom: 8px;">
                            <strong>数据库：</strong>MySQL
                        </div>
                        <div>
                            <strong>最后更新：</strong>{{ settings.updated_at if settings.updated_at else '刚刚' }}
                        </div>
                    </div>
                </div>
            </div>
        </div>
            </form>

            <!-- 备份与恢复 -->
            <div style="margin-top: 30px; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                <h3 style="margin: 0 0 16px 0; color: #303133; font-size: 16px;">备份与恢复</h3>
                <p style="margin: 0 0 16px 0; color: #909399; font-size: 13px;">备份文件包含 uploads 目录与 SQLite 格式的数据库，可以在任意数据库类型中恢复。</p>
                
                <!-- 下载备份 -->
                <div style="padding: 16px; background: #f0f9eb; border-radius: 6px; margin-bottom: 16px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px;">
                        <div>
                            <strong style="color: #67c23a;">下载备份</strong>
                            <div style="margin-top: 8px;">
                                <label style="display: flex; align-items: center; cursor: pointer;">
                                    <input type="checkbox" id="includeExtensionsCheck" checked style="margin-right: 8px;">
                                    <span style="font-size: 14px; color: #606266;">包含插件和主题文件</span>
                                </label>
                            </div>
                        </div>
                        <a id="downloadBackupBtn" class="el-button el-button--success" style="text-decoration: none; color: white; background: #67c23a; border-color: #67c23a;" href="{{ url_for('admin.download_backup') }}?include_extensions=true">
                            <i class="el-icon-download"></i> 立即下载备份
                        </a>
                    </div>
                </div>

                <!-- 导入备份 -->
                <div style="padding: 16px; background: #fdf6ec; border-radius: 6px;">
                    <strong style="color: #e6a23c;">导入备份</strong>
                    <form action="{{ url_for('admin.import_backup') }}" method="POST" enctype="multipart/form-data" style="margin-top: 12px;">
                        <!-- 隐藏字段确保值被发送 -->
                        <input type="hidden" name="restore_extensions" id="restoreExtensionsHidden" value="true">
                        <input type="hidden" name="overwrite_extensions" id="overwriteExtensionsHidden" value="true">
                        
                        <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
                            <input type="file" name="backup_file" accept=".zip" required style="flex: 1; min-width: 240px; padding: 6px 10px; border: 1px solid #dcdfe6; border-radius: 4px; background: white;" />
                            <button type="submit" class="el-button el-button--warning" style="border: none; cursor: pointer; background: #e6a23c; color: white; padding: 10px 20px; border-radius: 4px;">
                                <i class="el-icon-upload2"></i> 导入备份
                            </button>
                        </div>
                        <div style="display: flex; gap: 20px; margin-top: 12px;">
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="checkbox" id="restoreExtensionsCheck" checked style="margin-right: 8px;">
                                <span style="font-size: 14px; color: #606266;">恢复插件和主题文件</span>
                            </label>
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="checkbox" id="overwriteExtensionsCheck" checked style="margin-right: 8px;">
                                <span style="font-size: 14px; color: #606266;">覆盖同名文件</span>
                            </label>
                        </div>
                    </form>
                    <p style="margin: 10px 0 0; font-size: 12px; color: #f56c6c;">⚠️ 导入备份会覆盖当前数据库及上传文件，操作前请务必确认。</p>
                </div>
            </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
(function() {
    // 下载备份：控制是否包含插件和主题
    var includeCheck = document.getElementById('includeExtensionsCheck');
    var downloadBtn = document.getElementById('downloadBackupBtn');
    
    function updateDownloadUrl() {
        var baseUrl = '{{ url_for("admin.download_backup") }}';
        if (includeCheck.checked) {
            downloadBtn.href = baseUrl + '?include_extensions=true';
        } else {
            downloadBtn.href = baseUrl;
        }
    }
    
    includeCheck.addEventListener('change', updateDownloadUrl);
    updateDownloadUrl();
    
    // 导入备份：控制隐藏字段的值
    var restoreCheck = document.getElementById('restoreExtensionsCheck');
    var restoreHidden = document.getElementById('restoreExtensionsHidden');
    var overwriteCheck = document.getElementById('overwriteExtensionsCheck');
    var overwriteHidden = document.getElementById('overwriteExtensionsHidden');
    
    restoreCheck.addEventListener('change', function() {
        restoreHidden.value = restoreCheck.checked ? 'true' : 'false';
    });
    
    overwriteCheck.addEventListener('change', function() {
        overwriteHidden.value = overwriteCheck.checked ? 'true' : 'false';
    });
})();
</script>
{% endblock %}
